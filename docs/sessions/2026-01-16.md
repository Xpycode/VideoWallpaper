# Session: 2026-01-16

## Goal
Sidebar UI Redesign - Convert the app from a 5-tab TabView interface to a modern NavigationSplitView sidebar layout matching macOS System Settings aesthetics.

## Context
- Previous session: Per-monitor playlists implementation
- Current phase: polish

## Progress

### Completed
- [x] Created SidebarItem.swift - navigation enum with icons and section groupings
- [x] Created SidebarView.swift - sidebar list with section headers
- [x] Created SidebarNavigationView.swift - main NavigationSplitView container
- [x] Extracted SourceFoldersView.swift from SettingsView
- [x] Extracted DisplaySettingsView.swift from SettingsView
- [x] Extracted AdvancedSettingsView.swift from SettingsView
- [x] Created NowPlayingView.swift (renamed from StatusTab)
- [x] Created PlaylistView.swift (renamed from PlaylistTab)
- [x] Updated VideoWallpaperApp.swift - uses SidebarNavigationView, window size 710x470
- [x] Updated project.pbxproj with new file references
- [x] Deleted old files: MainTabView.swift, SettingsView.swift, StatusTab.swift, PlaylistTab.swift
- [x] Enhanced Now Playing view with real-time playback info:
  - Current video filename display
  - Progress bar with time display (current/total)
  - "Video X of Y" playlist position
  - Compact status footer
- [x] Enhanced VideoPlayerManager with published properties: currentTime, duration, currentIndex, totalVideoCount
- [x] Added periodic time observer for progress tracking
- [x] Added primaryPlayerManager accessor to AppDelegate

### Decisions Made
- Used NavigationSplitView with `.balanced` style for System Settings-like layout
- Sidebar width: 200-260pt (ideal 215pt)
- Window size: 710x470 (matching System Settings)
- Preserved PlaylistView's internal monitor sub-tabs (horizontal scrolling tabs for per-monitor playlists)

## Files Changed

### Created (8 new)
| File | Purpose |
|------|---------|
| UI/SidebarItem.swift | Navigation enum with icons and section groupings |
| UI/SidebarView.swift | Sidebar list with section headers |
| UI/SidebarNavigationView.swift | Main NavigationSplitView container |
| UI/NowPlayingView.swift | Status and playback controls with live progress |
| UI/PlaylistView.swift | Video playlist editor |
| UI/SourceFoldersView.swift | Video folder configuration |
| UI/DisplaySettingsView.swift | Scaling, transitions, sync settings |
| UI/AdvancedSettingsView.swift | Power and startup settings |

### Modified
- App/VideoWallpaperApp.swift - Uses SidebarNavigationView
- Core/VideoPlayerManager.swift - Added playback info properties
- App/AppDelegate.swift - Added primaryPlayerManager accessor
- VideoWallpaper.xcodeproj/project.pbxproj - Updated file references

### Deleted
- UI/MainTabView.swift
- UI/SettingsView.swift
- UI/StatusTab.swift
- UI/PlaylistTab.swift

---

## Session 2 - Video Previews & Dark Mode

### Goal
Add live video preview to Now Playing and thumbnails to playlist rows. Force dark mode.

### Progress
- [x] Created ThumbnailCache.swift - generates video thumbnails using AVAssetImageGenerator
- [x] Created VideoPreviewView.swift - live video preview using AVPlayerLayer (NSViewRepresentable)
- [x] Updated NowPlayingView - replaced static film icon with live 240x135 video preview
- [x] Updated PlaylistView - added 64x36 thumbnails to each video row
- [x] Added forced dark mode via `NSApp.appearance = NSAppearance(named: .darkAqua)`

### Decisions Made
- **Live preview for Now Playing** - Uses AVPlayerLayer connected to same AVPlayer instances as desktop wallpaper
- **Static thumbnails for playlist** - Can't run 47 simultaneous video players; thumbnails extracted from 1 second into video
- **Thumbnail cache** - NSCache with 50 item limit, auto-evicts under memory pressure
- **Force dark mode** - Set once in applicationDidFinishLaunching, affects all windows

### Files Changed

#### Created
| File | Purpose |
|------|---------|
| Core/ThumbnailCache.swift | Async thumbnail generation with AVAssetImageGenerator |
| UI/VideoPreviewView.swift | NSViewRepresentable wrapping AVPlayerLayer for live preview |

#### Modified
| File | Change |
|------|--------|
| UI/NowPlayingView.swift | Live video preview instead of static icon |
| UI/PlaylistView.swift | Added thumbnails to VideoRowView |
| App/AppDelegate.swift | Force dark mode appearance |
| Resources/Info.plist | CFBundleName and CFBundleDisplayName set to "Video Wallpaper" |
| project.pbxproj | Added new file references |

---

## Session 3 - Portal-Inspired Features Implementation

### Goal
Implement all 13 features from the `docs/plans/portal-inspired-features.md` plan across 5 sprints.

### Progress

#### Sprint 1: Quick Wins ✅
- [x] Start playback on launch - `autoPlayOnLaunch` UserDefault, AppDelegate check
- [x] Prevent display sleep - `preventDisplaySleep` setting, VideoPlayerManager integration
- [x] Send Support Info - `SupportInfoExporter.swift` with system/app diagnostics

#### Sprint 2: Audio Foundation ✅
- [x] Audio volume control - `audioMuted`/`audioVolume` settings, slider in DisplaySettingsView
- [x] Pause audio on screen lock - `ScreenLockMonitor.swift` using DistributedNotificationCenter
- [x] Cache management UI - ThumbnailCache tracking, clear button in AdvancedSettingsView

#### Sprint 3: Platform Integration ✅
- [x] Now Playing / media keys - `MediaKeyHandler.swift` with MPRemoteCommandCenter
- [x] Application visibility picker - `AppVisibilityManager.swift` for Menu Bar Only / Both

#### Sprint 4: Named Playlists ✅
- [x] Multiple named playlists - `NamedPlaylist.swift`, `PlaylistLibrary.swift`, `PlaylistLibraryView.swift`
- [x] Playlist sorting - `PlaylistSortOrder` enum with 5 sort options

#### Sprint 5: Advanced Features ✅
- [x] Per-display playlist assignment - `assignedPlaylistId` in PlaylistPersistence, picker in DisplaySettingsView
- [x] Immersive Now Playing view - Full redesign with large preview, hover controls, gradient overlay
- [x] Quick controls overlay - `QuickControlsPanel.swift`, `QuickControlsWindowController.swift` (NSPanel)

### Files Created (11 new)
| File | Purpose |
|------|---------|
| Core/NamedPlaylist.swift | Named playlist data model with sort orders |
| Core/PlaylistLibrary.swift | CRUD operations for named playlists |
| Core/MediaKeyHandler.swift | Now Playing info & media key commands |
| Utilities/SupportInfoExporter.swift | Diagnostic info generation |
| Utilities/ScreenLockMonitor.swift | Screen lock/unlock detection |
| Utilities/AppVisibilityManager.swift | Dock/Menu bar visibility control |
| UI/PlaylistLibraryView.swift | Named playlists management UI |
| UI/QuickControlsPanel.swift | Floating controls SwiftUI view |
| Desktop/QuickControlsWindowController.swift | NSPanel for floating controls |

### Files Modified (10)
| File | Changes |
|------|---------|
| App/AppDelegate.swift | Auto-play, screen lock, media keys, quick controls |
| Core/VideoPlayerManager.swift | Audio control, display sleep, settings observers |
| Core/ThumbnailCache.swift | ObservableObject, cache size tracking |
| Core/PlaylistPersistence.swift | assignedPlaylistId for per-display playlists |
| UI/AdvancedSettingsView.swift | Power, startup, storage, support sections |
| UI/DisplaySettingsView.swift | Audio controls, playlist picker |
| UI/NowPlayingView.swift | Immersive redesign with hover controls |
| UI/SidebarItem.swift | Added "playlists" navigation item |
| UI/SidebarNavigationView.swift | Route to PlaylistLibraryView |
| UI/StatusMenuView.swift | Quick controls toggle |

### New UserDefaults Keys
- `autoPlayOnLaunch`, `preventDisplaySleep`, `pauseOnScreenLock`
- `audioMuted`, `audioVolume`
- `applicationVisibility` (0=Both, 1=MenuBarOnly)
- `playlistLibrary` (JSON encoded [NamedPlaylist])
- `playlist_<screenId>_assignedPlaylist` (UUID string)

### Decisions Made
- Named playlists stored as single JSON blob in UserDefaults
- Screen lock detection uses DistributedNotificationCenter for "com.apple.screenIsLocked"
- Quick controls use NSPanel with `.floating` level and `.nonactivatingPanel` style
- Immersive Now Playing shows controls on hover or when paused

---

## Session 4 - Consolidated Playlist UI

### Goal
Merge "Playlists" and "Current Playlist" into a single tabbed interface where each tab is a playlist, and selecting a tab makes that playlist active for playback.

### Progress
- [x] Connected Named Playlists to Playback system
- [x] Modified `PlaylistManager` to check `assignedPlaylistId` and use `NamedPlaylist.activeVideoURLs()`
- [x] Modified `VideoPlayerManager.reloadPlaylist()` to use assigned playlist if set
- [x] Removed `.playlist` ("Current Playlist") from sidebar
- [x] Created `ConsolidatedPlaylistView.swift` - main tabbed playlist interface
- [x] Created `PlaylistTabBar.swift` - scrollable horizontal tabs with context menus
- [x] Added `playlistDidChange` notification for triggering playlist reloads
- [x] Fixed `VideoPreviewView` to update when active player changes (layer z-order issue)

### Files Created
| File | Purpose |
|------|---------|
| UI/ConsolidatedPlaylistView.swift | Tabbed playlist interface with monitor selector |
| UI/PlaylistTabBar.swift | Scrollable tab bar with context menus (rename/duplicate/delete) |

### Files Modified
| File | Change |
|------|--------|
| Core/PlaylistManager.swift | Added `loadFromNamedPlaylist()`, checks `assignedPlaylistId` |
| Core/VideoPlayerManager.swift | `reloadPlaylist()` uses assigned NamedPlaylist if set |
| UI/SidebarItem.swift | Removed `.playlist` case |
| UI/SidebarNavigationView.swift | Routes `.playlists` → `ConsolidatedPlaylistView` |
| App/AppDelegate.swift | Listens for `playlistDidChange` notification |
| UI/VideoPreviewView.swift | Fixed layer swapping on player transition |

### Decisions Made
- Each named playlist stores its own shuffle/loop settings
- "Default" playlist auto-syncs with source folders via refresh button
- Tabs show video count badges
- Active playlist indicated with green checkmark
- "Set Active" button assigns playlist and triggers reload notification

### Data Flow
```
Tab selected → View playlist contents
"Set Active" → PlaylistPersistence.assignedPlaylistId = playlist.id
            → Notification.playlistDidChange posted
            → AppDelegate.reloadPlaylist()
            → VideoPlayerManager uses NamedPlaylist.activeVideoURLs()
```

## Next Session
- Test multi-monitor independent mode (non-sync)
- Add drag-and-drop videos between playlists
- Consider keyboard shortcuts

## Notes
- NavigationSplitView with `.constant(.all)` columnVisibility keeps sidebar always visible
- Section headers in List with `.sidebar` style give the grouped System Settings appearance
- Periodic time observer fires every 0.5s for smooth progress display
- AVPlayerLayer can only have one superlayer - each view creates its own layers pointing to shared AVPlayer instances
- Thumbnail generation uses 1 second (or 10% for short videos) to avoid black intro frames
