# Session: 2026-01-17

## Goal
Implement the fixing plan from the 2026-01-16 code reviews (Issues #1-9)

## Context
- Previous session: Code review consolidation and validation
- Current phase: implementation
- Plan: `fixing-plan--2026-01-16.md` with 20 prioritized issues from 3 code reviews

## Progress

### Completed
- [x] **Issue #1**: Loop controls - Changed hardcoded UserDefaults to `playlistManager.loopEnabled`
- [x] **Issue #3**: Playlist edit notifications - Added `.playlistDidChange` posts to 4 mutation methods
- [x] **Issue #4**: Screen ID persistence - Replaced `localizedName` with stable `displayID` for persistence keys
- [x] **Issue #2**: Video scaling runtime updates - Added Combine observer to update scaling when preference changes
- [x] **Issue #5**: ThumbnailCache thread safety - Added `@MainActor` to class, removed redundant dispatch calls
- [x] **Issue #6**: Metadata loading for named playlists - Extended VideoMetadataLoader for PlaylistLibrary
- [x] **Issue #7**: Now Playing playlist source - Added `activePlaylist` property to VideoPlayerManager
- [x] **Issue #8**: Video preview observer scope - Added player identity check before responding to transitions
- [x] **Issue #9**: Media key handler accumulation - Added flag to prevent duplicate target registration
- [x] Build verified successful

### Files Modified
| File | Changes |
|------|---------|
| `Core/VideoPlayerManager.swift` | Fixed loop logic, added `activePlaylist` property |
| `Core/PlaylistLibrary.swift` | Added notification posts, added `.playlistDidChange` extension |
| `Core/PlaylistManager.swift` | Made `loopEnabled` property internal |
| `Core/ThumbnailCache.swift` | Added `@MainActor`, simplified thread handling |
| `Core/VideoMetadataLoader.swift` | Added methods for named playlist metadata loading |
| `Core/MediaKeyHandler.swift` | Added `commandTargetsRegistered` flag |
| `Desktop/DesktopWindowController.swift` | Changed to use `screen.stableId` for persistence |
| `Desktop/DesktopVideoView.swift` | Added Combine observer for scaling preference |
| `Desktop/MultiMonitorManager.swift` | Added `stableId` computed property to NSScreen extension |
| `UI/ConsolidatedPlaylistView.swift` | Updated screen selection to use stableId, added metadata loading |
| `UI/PlaylistView.swift` | Updated screen selection to use stableId |
| `UI/NowPlayingView.swift` | Changed to use `manager.activePlaylist?.name` |
| `UI/VideoPreviewView.swift` | Added player identity check for transitions |

## Decisions Made
- Used `@MainActor` for ThumbnailCache instead of actor pattern (simpler for ObservableObject)
- Added `stableId` computed property to NSScreen instead of inline displayID conversion
- Kept notification extension in PlaylistLibrary.swift (avoids adding new file to Xcode project)
- Made `loopEnabled` internal in PlaylistManager rather than creating wrapper property

## Next Session
- Run the app and manually verify all fixes work correctly
- Consider Phase 4 items (unit tests, battery resume logic, support info export)
- Consider Phase 5 refinements (refactor large classes, Sendable conformance)

## Notes
- All 9 critical/high priority issues from the fixing plan have been implemented
- Build succeeds without errors
- SourceKit shows some indexing errors but these are transient and don't affect the build

---

# Session: 2026-01-17 (Part 2)

## Goal
Implement 4 new features from the feature plan

## Context
- Previous session: Bug fixes implementation (Issues #1-9)
- Current phase: Feature implementation

## Progress

### Completed
- [x] **Playback Speed Control** - Slider in Display settings (0.5x - 2.0x)
- [x] **Mute/Volume Quick Access** - Toggle and slider in menu bar dropdown
- [x] **Schedule Playback** - Start/end times with day selection in Advanced settings
- [x] **Global Hotkeys** - System-wide keyboard shortcuts with customization UI
- [x] Build verified successful

### Files Created
| File | Purpose |
|------|---------|
| `Core/ScheduleManager.swift` | Manages scheduled playback times, monitors current time |
| `Core/HotkeyManager.swift` | Global hotkey detection with configurable shortcuts |

### Files Modified
| File | Changes |
|------|---------|
| `Core/VideoPlayerManager.swift` | Added playback rate support to both players |
| `App/AppDelegate.swift` | Integrated ScheduleManager and HotkeyManager |
| `UI/DisplaySettingsView.swift` | Added playback speed slider in new "Playback" section |
| `UI/StatusMenuView.swift` | Added mute toggle button and volume slider |
| `UI/AdvancedSettingsView.swift` | Added Schedule and Global Hotkeys configuration sections |
| `VideoWallpaper.xcodeproj/project.pbxproj` | Added new files to project |

## Features Implemented

### 1. Playback Speed Control
- Slider from 0.5x to 2.0x in 0.25 increments
- Stored in UserDefaults as `playbackRate`
- Applied to both AVPlayers in transitions and play() calls

### 2. Mute/Volume Quick Access
- Speaker button toggles mute
- Volume slider (disabled when muted)
- Located between playback controls and window options in menu bar

### 3. Schedule Playback
- Enable/disable toggle
- Start and end time pickers (HH:MM format)
- Day selection buttons (Sun-Sat)
- Auto-pause/resume based on schedule
- Default: weekdays only

### 4. Global Hotkeys
- Enable/disable toggle
- Configurable shortcuts with recording UI
- Default hotkeys:
  - `Cmd+Shift+P` - Play/Pause
  - `Cmd+Shift+→` - Next video
  - `Cmd+Shift+←` - Previous video
  - `Cmd+Shift+M` - Mute toggle
- Reset to Defaults button

## Decisions Made
- Used NSEvent.addGlobalMonitorForEvents for global hotkeys (requires Accessibility permission)
- Schedule stores day selection as array of integers (0=Sun, 6=Sat)
- Hotkey configs stored as keyCode + modifiers in UserDefaults
- Require at least one modifier key for global hotkeys

## Next Session
- Test all 4 new features manually
- Add Accessibility permission request for global hotkeys
- Consider adding volume up/down as hotkey actions
- Consider schedule presets (e.g., "Weekdays", "Weekend", "Always")

---

# Session: 2026-01-17 (Part 3)

## Goal
Fix global hotkeys and investigate playlist issues

## Context
- Previous session: Feature implementation (4 new features)
- Current phase: Bug fixing and refinement

## Progress

### Completed
- [x] **Global Hotkeys Permission** - Added Accessibility permission checking to HotkeyManager
  - `AXIsProcessTrusted()` to check permission
  - `requestAccessibilityPermission()` to prompt and open System Settings
  - UI shows "Grant Access" button when not permitted, green checkmark when granted
  - Toggle disabled until permission granted
- [x] **Permission Auto-Refresh** - Added `onReceive` for `didBecomeActiveNotification` to refresh permission status when returning from System Settings
- [x] **UI Freeze Bug** - Fixed app becoming unresponsive on launch
  - **Root Cause**: `NSEvent.addGlobalMonitorForEvents` called during singleton init blocks the main thread
  - **Fix**: Defer `startMonitoring()` with `DispatchQueue.main.async`
  - Added `isInitialized` guard to prevent `didSet` from firing during init

### Files Modified
| File | Changes |
|------|---------|
| `Core/HotkeyManager.swift` | Added permission checking, deferred startMonitoring, isInitialized guard |
| `UI/AdvancedSettingsView.swift` | Added permission UI, onReceive for app activation |

## Decisions Made
- Use `DispatchQueue.main.async` to defer global event monitor setup (prevents init blocking)
- Show permission status inline in Global Hotkeys section rather than separate alert
- Auto-check permission when app becomes active (handles returning from System Settings)

## Bugs Found (Not Yet Fixed)
- **Playlist/Now Playing disconnect**: Videos play from folder scanning but Playlists UI shows 0 videos
  - Two separate systems: FolderBookmarkManager (playback) vs PlaylistLibrary (UI)
  - Need to sync Default playlist from Video Folders

## Next Session
- ~~Implement playlist auto-sync from Video Folders~~ ✓ Done in Part 4
- Address user feedback:
  - Player should only play when a playlist is activated
  - Playlist name should appear in Now Playing
  - Multi-display: decide what Now Playing shows with different playlists per display
- Test global hotkeys work end-to-end

---

# Session: 2026-01-17 (Part 4)

## Goal
Fix playlist sync between Video Folders and PlaylistLibrary

## Context
- Previous session: Global hotkeys permission fix, UI freeze fix
- Current phase: Bug fixing
- Problem: Videos play from folder scanning but Playlists UI shows 0 videos

## Progress

### Completed
- [x] **Playlist Sync Implementation** - Videos from Video Folders now sync to PlaylistLibrary
  - Added `syncFromVideoFolders()` to PlaylistLibrary
  - Runs folder scanning on background queue (avoids UI freeze)
  - Creates/updates "Default" playlist automatically
  - Merges new videos, removes deleted ones, preserves exclusion state
- [x] **Folder Change Notifications** - FolderBookmarkManager posts `videoFoldersDidChange`
  - Posted when folders are added or removed
  - PlaylistLibrary observes and triggers re-sync
- [x] **Auto-Assignment** - Default playlist auto-assigned for playback
  - When no playlist assigned to a screen, Default is auto-assigned
  - Ensures playback uses the synced playlist
- [x] **Tested and Verified** - App launched, Playlists UI shows 47 videos in Default playlist
- [x] **Pushed to Remote** - 2 commits pushed to main

### Files Modified
| File | Changes |
|------|---------|
| `Core/FolderBookmarkManager.swift` | Added `videoFoldersDidChange` notification on add/remove |
| `Core/PlaylistLibrary.swift` | Added `syncFromVideoFolders()`, folder change observer, auto-assignment |

### Commits
1. `634ccf0` - Add playback speed, volume controls, schedule, and global hotkeys
2. `80241e7` - Fix playlist sync between Video Folders and PlaylistLibrary

## Architecture Fix

The root cause was two disconnected systems:
- **FolderBookmarkManager**: Scans folders → feeds playback directly
- **PlaylistLibrary**: Stores named playlists → shown in UI

The fix bridges them:
1. `syncFromVideoFolders()` scans folders on background queue
2. Creates/updates "Default" playlist with discovered videos
3. Auto-assigns Default playlist for playback when nothing assigned
4. Observes folder changes to keep Default playlist in sync

## Decisions Made
- Run folder scanning on `DispatchQueue.global(qos: .userInitiated)` to avoid UI freeze
- Merge strategy: preserve existing items' exclusion state, add new, remove missing
- Auto-assign only to `PlaylistPersistence.shared` (not per-screen) to avoid complexity

## Test Results
- Default playlist created with 47 videos
- Thumbnails, durations, and resolutions displayed correctly
- Video wallpaper continues playing on desktop
- Shuffle/Loop controls functional

## Next Session
- Consider adding manual "Refresh from Folders" button
- Address remaining user feedback items
- Test on fresh install (no existing playlists)
